{"version":3,"sources":["../../../../../src/streaming/controllers/SourceBufferController.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;2LA8BwB,mBAAmB,uFACtB,qBAAqB,yFACvB,0BAA0B,iGACpB,yBAAyB,mEAElD,IAAM,yBAAyB,CAAG,EAAE,CAAC,AACrC,IAAM,iBAAiB,CAAG,CAAC,CAAC,AAC5B,IAAM,iBAAiB,CAAG,CAAC,CAAC,AAC5B,IAAM,oBAAoB,CAAG,gCAAgC,CAAC,AAC9D,IAAM,oBAAoB,CAAG,uBAAuB,CAAC,AAErD,SAAS,sBAAsB,CAAC,MAAM,CAAE,CAEpC,IAAI,OAAO,CAAG,IAAI,CAAC,OAAO,CAAC,AAC3B,IAAI,QAAQ,CAAG,8BAAS,OAAO,CAAC,CAAC,WAAW,EAAE,CAAC,AAC/C,IAAI,cAAc,CAAG,MAAM,CAAC,cAAc,CAAC,AAE3C,IAAI,QAAQ,UAAA,CAAC,AAEb,SAAS,kBAAkB,CAAC,WAAW,CAAE,SAAS,CAAE,CAEhD,IAAI,KAAK,CAAG,SAAS,CAAC,KAAK,CAAC,AAC5B,IAAI,MAAM,CAAG,IAAI,CAAC,AAElB,GAAI;;;;AAKA,GAAI,KAAK,CAAC,KAAK,CAAC,6CAA6C,CAAC,CAAE,CAC5D,MAAM,IAAI,KAAK,CAAC,sBAAsB,CAAC,CAAC,CAC3C,AAED,MAAM,GAAG,WAAW,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC,CAE/C,AAAC,MAAO,EAAE,EAAE;AAET,GAAI,AAAC,SAAS,CAAC,MAAM,IAAM,KAAK,CAAC,OAAO,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC,AAAC,IAAK,KAAK,CAAC,OAAO,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC,AAAC,CAAE,CACxG,MAAM,GAAG,cAAc,CAAC,mBAAmB,EAAE,CAAC,CACjD,KAAM,CACH,MAAM,EAAE,CAAC,CACZ,CACJ,AAED,OAAO,MAAM,CAAC,CACjB,AAED,SAAS,kBAAkB,CAAC,WAAW,CAAE,MAAM,CAAE,CAC7C,GAAI,CACA,WAAW,CAAC,kBAAkB,CAAC,MAAM,CAAC,CAAC,CAC1C,AAAC,MAAO,EAAE,EAAE,EAAE,CAClB,AAED,SAAS,cAAc,CAAC,MAAM,CAAE,IAAI,CAAE,SAAS,CAAE,CAC7C,IAAI,MAAM,CAAG,IAAI,CAAC,AAClB,IAAI,KAAK,CAAG,CAAC,CAAC,AACd,IAAI,GAAG,CAAG,CAAC,CAAC,AACZ,IAAI,UAAU,CAAG,IAAI,CAAC,AACtB,IAAI,OAAO,CAAG,IAAI,CAAC,AACnB,IAAI,GAAG,CAAG,CAAC,CAAC,AAEZ,IAAI,GAAG,UAAA,CACH,CAAC,UAAA,CAAC,AAEN,IAAI,KAAK,CAAI,SAAS,IAAI,IAAI,AAAC,CAAC,AAEhC,GAAI,CACA,MAAM,GAAG,MAAM,CAAC,QAAQ,CAAC,CAC5B,AAAC,MAAO,EAAE,EAAE,CACT,OAAO,IAAI,CAAC,CACf,AAED,GAAI,MAAM,KAAK,IAAI,IAAI,MAAM,KAAK,SAAS,CAAE,CACzC,IAAK,CAAC,GAAG,CAAC,CAAE,GAAG,GAAG,MAAM,CAAC,MAAM,CAAE,CAAC,GAAG,GAAG,CAAE,CAAC,EAAE,EAAE,CAC3C,KAAK,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,AACxB,GAAG,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,AACpB,GAAI,UAAU,KAAK,IAAI,CAAE,CACrB,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,GAAG,IAAI,CAAC,CAAC,AAC7B,GAAI,IAAI,IAAI,KAAK,IAAI,IAAI,GAAG,GAAG,CAAE;AAE7B,UAAU,GAAG,KAAK,CAAC,AACnB,OAAO,GAAG,GAAG,CAAC,CACjB,KAAM,GAAI,GAAG,IAAI,KAAK,CAAE;AAErB,UAAU,GAAG,KAAK,CAAC,AACnB,OAAO,GAAG,GAAG,CAAC,CACjB,CACJ,KAAM,CACH,GAAG,GAAG,KAAK,GAAG,OAAO,CAAC,AACtB,GAAI,GAAG,IAAI,KAAK,CAAE;AAEd,OAAO,GAAG,GAAG,CAAC,CACjB,KAAM,CACH,MAAM,CACT,CACJ,CACJ,AAED,GAAI,UAAU,KAAK,IAAI,CAAE,CACrB,OAAO,CACH,KAAK,CAAE,UAAU,CACjB,GAAG,CAAE,OAAO,CACf,CAAC,CACL,CACJ,AAED,OAAO,IAAI,CAAC,CACf,AAED,SAAS,YAAY,CAAC,MAAM,CAAE,CAC1B,IAAI,MAAM,CAAG,IAAI,CAAC,AAElB,GAAI,CACA,MAAM,GAAG,MAAM,CAAC,QAAQ,CAAC,AACzB,OAAO,MAAM,CAAC,CACjB,AAAC,MAAO,EAAE,EAAE,CACT,OAAO,IAAI,CAAC,CACf,CACJ,AAED,SAAS,oBAAoB,CAAC,MAAM,CAAE,CAClC,IAAI,MAAM,CAAG,YAAY,CAAC,MAAM,CAAC,CAAC,AAClC,IAAI,iBAAiB,CAAG,CAAC,CAAC,AAC1B,IAAI,EAAE,UAAA,CACF,CAAC,UAAA,CAAC,AAEN,GAAI,CAAC,MAAM,CAAE,OAAO,iBAAiB,CAAC,AAEtC,IAAK,CAAC,GAAG,CAAC,CAAE,EAAE,GAAG,MAAM,CAAC,MAAM,CAAE,CAAC,GAAG,EAAE,CAAE,CAAC,EAAE,EAAE,CACzC,iBAAiB,IAAI,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CACxD,AAED,OAAO,iBAAiB,CAAC,CAC5B,AAED,SAAS,eAAe,CAAC,MAAM,CAAE,IAAI,CAAE,SAAS,CAAE,CAE9C,IAAI,KAAK,UAAA,CACL,MAAM,UAAA,CAAC,AAEX,KAAK,GAAG,cAAc,CAAC,MAAM,CAAE,IAAI,CAAE,SAAS,CAAC,CAAC,AAEhD,GAAI,KAAK,KAAK,IAAI,CAAE,CAChB,MAAM,GAAG,CAAC,CAAC,CACd,KAAM,CACH,MAAM,GAAG,KAAK,CAAC,GAAG,GAAG,IAAI,CAAC,CAC7B,AAED,OAAO,MAAM,CAAC,CACjB,AAED,SAAS,kBAAkB,CAAC,aAAa,CAAE,MAAM,CAAE,CAC/C,GAAI,CAAC,MAAM,CAAE,OAAO,IAAI,CAAC;;AAKzB,IAAI,SAAS,CAAG,YAAY,CAAC,MAAM,CAAC,CAAC,AACrC,IAAI,QAAQ,UAAA,CACR,MAAM,UAAA,CACN,UAAU,UAAA,CACV,QAAQ,UAAA,CACR,YAAY,UAAA,CACZ,gBAAgB,UAAA,CAChB,YAAY,UAAA,CACZ,QAAQ,UAAA,CACR,IAAI,UAAA,CAAC,AAET,GAAI,CAAC,SAAS,CAAE,OAAO,IAAI,CAAC,AAE5B,IAAK,IAAI,CAAC,CAAG,CAAC,CAAE,EAAE,CAAG,SAAS,CAAC,MAAM,CAAE,CAAC,GAAG,EAAE,CAAE,CAAC,EAAE,EAAE,CAChD,QAAQ,GAAG,aAAa,CAAC,MAAM,GAAG,CAAC,CAAC,AACpC,YAAY,GAAG,QAAQ,CAAG,CACtB,KAAK,CAAE,aAAa,CAAC,KAAK,CAAC,CAAC,CAAC,CAC7B,GAAG,CAAE,aAAa,CAAC,GAAG,CAAC,CAAC,CAAC,CAC5B,CAAG,IAAI,CAAC,AACT,QAAQ,GAAG,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,AAC9B,MAAM,GAAG,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;;;;;;;AAU1B,GAAI,CAAC,YAAY,CAAE,CACf,IAAI,GAAG,CACH,KAAK,CAAE,QAAQ,CACf,GAAG,CAAE,MAAM,CACd,CAAC,AACF,OAAO,IAAI,CAAC,CACf,AAED,UAAU,GAAG,YAAY,CAAC,KAAK,KAAK,QAAQ,CAAC,AAC7C,QAAQ,GAAG,YAAY,CAAC,GAAG,KAAK,MAAM,CAAC;AAGvC,GAAI,UAAU,IAAI,QAAQ,CAAE,SAAS;AAGrC,GAAI,UAAU,CAAE,CACZ,IAAI,GAAG,CACH,KAAK,CAAE,YAAY,CAAC,GAAG,CACvB,GAAG,CAAE,MAAM,CACd,CAAC,CACL,KAAM,GAAI,QAAQ,CAAE,CACjB,IAAI,GAAG,CACH,KAAK,CAAE,QAAQ,CACf,GAAG,CAAE,YAAY,CAAC,KAAK,CAC1B,CAAC,CACL,KAAM;AAEH,IAAI,GAAG,CACH,KAAK,CAAE,QAAQ,CACf,GAAG,CAAE,MAAM,CACd,CAAC,AACF,OAAO,IAAI,CAAC,CACf;;;;;;;AASD,gBAAgB,GAAG,aAAa,CAAC,MAAM,GAAI,CAAC,GAAG,CAAC,AAAC,CAAG,CAChD,KAAK,CAAE,aAAa,CAAC,KAAK,CAAC,CAAC,GAAG,CAAC,CAAC,CACjC,GAAG,CAAE,aAAa,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,CAAC,CAChC,CAAG,IAAI,CAAC,AACT,YAAY,GAAG,AAAC,CAAC,GAAG,CAAC,GAAI,EAAE,CAAG,CAC1B,KAAK,CAAE,SAAS,CAAC,KAAK,CAAC,CAAC,GAAG,CAAC,CAAC,CAC7B,GAAG,CAAE,SAAS,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,CAAC,CAC5B,CAAG,IAAI,CAAC,AAET,GAAI,gBAAgB,KAAK,CAAC,YAAY,IAAK,YAAY,CAAC,KAAK,KAAK,gBAAgB,CAAC,KAAK,IAAI,YAAY,CAAC,GAAG,KAAK,gBAAgB,CAAC,GAAG,CAAC,AAAC,CAAE,CACrI,IAAI,CAAC,GAAG,GAAG,gBAAgB,CAAC,KAAK,CAAC,CACrC,AAED,OAAO,IAAI,CAAC,CACf,AAED,OAAO,IAAI,CAAC,CACf,AAED,SAAS,MAAM,CAAC,MAAM,CAAE,KAAK,CAAE,CAC3B,GAAI,CAAC,MAAM,IAAI,CAAC,KAAK,CAAE,CACnB,QAAQ,CAAC,OAAO,CAAC,8BAAO,6BAA6B,CAAE,CACnD,MAAM,CAAE,IAAI,CACZ,KAAK,CAAE,IAAI,CACX,KAAK,CAAE,+BAAgB,iBAAiB,CAAE,oBAAoB,CAAE,IAAI,CAAC,CACxE,CAAC,CAAC,AACH,OAAO,CACV,AACD,IAAI,KAAK,CAAG,KAAK,CAAC,KAAK,CAAC,AAExB,IAAI,YAAY,CAAG,AAAC,QAAQ,IAAI,MAAM,CAAI,QAAQ,CAAI,AAAC,cAAc,IAAI,MAAM,CAAI,cAAc,CAAG,IAAI,AAAC,CAAC;;;AAI1G,IAAI,YAAY,CAAG,MAAM,CAAC,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,KAAK,CAAC,CAAC,CAAE,CAAC,CAAC,CAAC,KAAK,QAAQ,CAAC,AAEpF,GAAI,CAAC,YAAY,CAAE,OAAO,AAE1B,gBAAgB,CAAC,MAAM,CAAE,UAAY,CACjC,GAAI,CACA,GAAI,YAAY,CAAE;AAEd,MAAM,CAAC,YAAY,CAAC,CAAC,KAAK,CAAE,KAAK,CAAC,CAAC,CACtC,KAAM,CACH,MAAM,CAAC,YAAY,CAAC,CAAC,KAAK,CAAC,CAAC,CAC/B;AAED,gBAAgB,CAAC,MAAM,CAAE,UAAY,CACjC,QAAQ,CAAC,OAAO,CAAC,8BAAO,6BAA6B,CAAE,CACnD,MAAM,CAAE,MAAM,CACd,KAAK,CAAE,KAAK,CACf,CAAC,CAAC,CACN,CAAC,CAAC,CACN,AAAC,MAAO,GAAG,EAAE,CACV,QAAQ,CAAC,OAAO,CAAC,8BAAO,6BAA6B,CAAE,CACnD,MAAM,CAAE,MAAM,CACd,KAAK,CAAE,KAAK,CACZ,KAAK,CAAE,+BAAgB,GAAG,CAAC,IAAI,CAAE,GAAG,CAAC,OAAO,CAAE,IAAI,CAAC,CACtD,CAAC,CAAC,CACN,CACJ,CAAC,CAAC,CACN,AAED,SAAS,MAAM,CAAC,MAAM,CAAE,KAAK,CAAE,GAAG,CAAE,WAAW,CAAE,CAC7C,GAAI,CAAC,MAAM,CAAE,CACT,QAAQ,CAAC,OAAO,CAAC,8BAAO,6BAA6B,CAAE,CACnD,MAAM,CAAE,MAAM,CACd,IAAI,CAAE,KAAK,CACX,EAAE,CAAE,GAAG,CACP,KAAK,CAAE,+BAAgB,iBAAiB,CAAE,oBAAoB,CAAE,IAAI,CAAC,CACxE,CAAC,CAAC,AACH,OAAO,CACV;AAED,gBAAgB,CAAC,MAAM,CAAE,UAAY,CACjC,GAAI,CACA,GAAI,AAAC,KAAK,IAAI,CAAC,IAAM,GAAG,GAAG,KAAK,AAAC,IAAK,WAAW,CAAC,UAAU,KAAK,OAAO,AAAC,CAAE,CACvE,MAAM,CAAC,MAAM,CAAC,KAAK,CAAE,GAAG,CAAC,CAAC,CAC7B;AAED,gBAAgB,CAAC,MAAM,CAAE,UAAY,CACjC,QAAQ,CAAC,OAAO,CAAC,8BAAO,6BAA6B,CAAE,CACnD,MAAM,CAAE,MAAM,CACd,IAAI,CAAE,KAAK,CACX,EAAE,CAAE,GAAG,CACV,CAAC,CAAC,CACN,CAAC,CAAC,CACN,AAAC,MAAO,GAAG,EAAE,CACV,QAAQ,CAAC,OAAO,CAAC,8BAAO,6BAA6B,CAAE,CACnD,MAAM,CAAE,MAAM,CACd,IAAI,CAAE,KAAK,CACX,EAAE,CAAE,GAAG,CACP,KAAK,CAAE,+BAAgB,GAAG,CAAC,IAAI,CAAE,GAAG,CAAC,OAAO,CAAE,IAAI,CAAC,CACtD,CAAC,CAAC,CACN,CACJ,CAAC,CAAC,CACN,AAED,SAAS,KAAK,CAAC,WAAW,CAAE,MAAM,CAAE,CAChC,GAAI,CACA,GAAI,WAAW,CAAC,UAAU,KAAK,MAAM,CAAE,CACnC,MAAM,CAAC,KAAK,EAAE,CAAC,CAClB,KAAM,GAAI,MAAM,CAAC,aAAa,IAAI,WAAW,CAAC,UAAU,KAAK,OAAO,CAAE,CACnE,MAAM,CAAC,KAAK,EAAE,CAAC;CAClB,CACJ,AAAC,MAAO,EAAE,EAAE,EAAE,CAClB,AAED,SAAS,gBAAgB,CAAC,MAAM,CAAE,QAAQ,CAAE,CACxC,IAAI,UAAU,UAAA,CAAC,AACf,IAAM,cAAc,CAAG,EAAE,CAAC,AAE1B,IAAM,kBAAkB,CAAG,SAArB,kBAAkB,EAAe;AAEnC,GAAI,MAAM,CAAC,QAAQ,CAAE,OAAO;AAE5B,aAAa,CAAC,UAAU,CAAC,CAAC,AAC1B,QAAQ,EAAE,CAAC,CACd,CAAC,AAEF,IAAM,gBAAgB,CAAG,SAAnB,gBAAgB,EAAe,CACjC,GAAI,MAAM,CAAC,QAAQ,CAAE,OAAO,AAE5B,MAAM,CAAC,mBAAmB,CAAC,WAAW,CAAE,gBAAgB,CAAE,KAAK,CAAC,CAAC,AACjE,QAAQ,EAAE,CAAC,CACd,CAAC,AAEF,GAAI,CAAC,MAAM,CAAC,QAAQ,CAAE,CAClB,QAAQ,EAAE,CAAC,AACX,OAAO,CACV;AAGD,GAAI,OAAO,MAAM,CAAC,gBAAgB,KAAK,UAAU,CAAE,CAC/C,GAAI,CACA,MAAM,CAAC,gBAAgB,CAAC,WAAW,CAAE,gBAAgB,CAAE,KAAK,CAAC,CAAC,CACjE,AAAC,MAAO,GAAG,EAAE;AAEV,UAAU,GAAG,WAAW,CAAC,kBAAkB,CAAE,cAAc,CAAC,CAAC,CAChE,CACJ,KAAM;AAEH,UAAU,GAAG,WAAW,CAAC,kBAAkB,CAAE,cAAc,CAAC,CAAC,CAChE,CACJ,AAED,QAAQ,GAAG,CACP,MAAM,CAAE,MAAM,CACd,MAAM,CAAE,MAAM,CACd,KAAK,CAAE,KAAK,CACZ,kBAAkB,CAAE,kBAAkB,CACtC,kBAAkB,CAAE,kBAAkB,CACtC,cAAc,CAAE,cAAc,CAC9B,YAAY,CAAE,YAAY,CAC1B,oBAAoB,CAAE,oBAAoB,CAC1C,eAAe,CAAE,eAAe,CAChC,kBAAkB,CAAE,kBAAkB,CACzC,CAAC,AAEF,OAAO,QAAQ,CAAC,CACnB,AAED,sBAAsB,CAAC,qBAAqB,GAAG,wBAAwB,CAAC,AACxE,IAAI,OAAO,CAAG,8BAAa,mBAAmB,CAAC,sBAAsB,CAAC,CAAC,AACvE,OAAO,CAAC,yBAAyB,GAAG,yBAAyB,CAAC,AAC9D,8BAAa,sBAAsB,CAAC,sBAAsB,CAAC,qBAAqB,CAAE,OAAO,CAAC,CAAC,qBAC5E,OAAO","file":"SourceBufferController.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport DashJSError from '../vo/DashJSError';\nimport EventBus from '../../core/EventBus';\nimport Events from '../../core/events/Events';\nimport FactoryMaker from '../../core/FactoryMaker';\n\nconst QUOTA_EXCEEDED_ERROR_CODE = 22;\nconst APPEND_ERROR_CODE = 1;\nconst REMOVE_ERROR_CODE = 2;\nconst APPEND_ERROR_MESSAGE = 'buffer or chunk is not defined';\nconst REMOVE_ERROR_MESSAGE = 'buffer is not defined';\n\nfunction SourceBufferController(config) {\n\n    let context = this.context;\n    let eventBus = EventBus(context).getInstance();\n    let textController = config.textController;\n\n    let instance;\n\n    function createSourceBuffer(mediaSource, mediaInfo) {\n\n        let codec = mediaInfo.codec;\n        let buffer = null;\n\n        try {\n            // Safari claims to support anything starting 'application/mp4'.\n            // it definitely doesn't understand 'application/mp4;codecs=\"stpp\"'\n            // - currently no browser does, so check for it and use our own\n            // implementation. The same is true for codecs=\"wvtt\".\n            if (codec.match(/application\\/mp4;\\s*codecs=\"(stpp|wvtt).*\"/i)) {\n                throw new Error('not really supported');\n            }\n\n            buffer = mediaSource.addSourceBuffer(codec);\n\n        } catch (ex) {\n            // Note that in the following, the quotes are open to allow for extra text after stpp and wvtt\n            if ((mediaInfo.isText) || (codec.indexOf('codecs=\"stpp') !== -1) || (codec.indexOf('codecs=\"wvtt') !== -1)) {\n                buffer = textController.getTextSourceBuffer();\n            } else {\n                throw ex;\n            }\n        }\n\n        return buffer;\n    }\n\n    function removeSourceBuffer(mediaSource, buffer) {\n        try {\n            mediaSource.removeSourceBuffer(buffer);\n        } catch (ex) {}\n    }\n\n    function getBufferRange(buffer, time, tolerance) {\n        let ranges = null;\n        let start = 0;\n        let end = 0;\n        let firstStart = null;\n        let lastEnd = null;\n        let gap = 0;\n\n        let len,\n            i;\n\n        let toler = (tolerance || 0.15);\n\n        try {\n            ranges = buffer.buffered;\n        } catch (ex) {\n            return null;\n        }\n\n        if (ranges !== null && ranges !== undefined) {\n            for (i = 0, len = ranges.length; i < len; i++) {\n                start = ranges.start(i);\n                end = ranges.end(i);\n                if (firstStart === null) {\n                    gap = Math.abs(start - time);\n                    if (time >= start && time < end) {\n                        // start the range\n                        firstStart = start;\n                        lastEnd = end;\n                    } else if (gap <= toler) {\n                        // start the range even though the buffer does not contain time 0\n                        firstStart = start;\n                        lastEnd = end;\n                    }\n                } else {\n                    gap = start - lastEnd;\n                    if (gap <= toler) {\n                        // the discontinuity is smaller than the tolerance, combine the ranges\n                        lastEnd = end;\n                    } else {\n                        break;\n                    }\n                }\n            }\n\n            if (firstStart !== null) {\n                return {\n                    start: firstStart,\n                    end: lastEnd\n                };\n            }\n        }\n\n        return null;\n    }\n\n    function getAllRanges(buffer) {\n        let ranges = null;\n\n        try {\n            ranges = buffer.buffered;\n            return ranges;\n        } catch (ex) {\n            return null;\n        }\n    }\n\n    function getTotalBufferedTime(buffer) {\n        let ranges = getAllRanges(buffer);\n        let totalBufferedTime = 0;\n        let ln,\n            i;\n\n        if (!ranges) return totalBufferedTime;\n\n        for (i = 0, ln = ranges.length; i < ln; i++) {\n            totalBufferedTime += ranges.end(i) - ranges.start(i);\n        }\n\n        return totalBufferedTime;\n    }\n\n    function getBufferLength(buffer, time, tolerance) {\n\n        let range,\n            length;\n\n        range = getBufferRange(buffer, time, tolerance);\n\n        if (range === null) {\n            length = 0;\n        } else {\n            length = range.end - time;\n        }\n\n        return length;\n    }\n\n    function getRangeDifference(currentRanges, buffer) {\n        if (!buffer) return null;\n\n        //TODO we may need to look for a more elegant and robust method\n        // The logic below checks that is the difference between currentRanges and actual SourceBuffer ranges\n\n        let newRanges = getAllRanges(buffer);\n        let newStart,\n            newEnd,\n            equalStart,\n            equalEnd,\n            currentRange,\n            nextCurrentRange,\n            nextNewRange,\n            hasRange,\n            diff;\n\n        if (!newRanges) return null;\n\n        for (let i = 0, ln = newRanges.length; i < ln; i++) {\n            hasRange = currentRanges.length > i;\n            currentRange = hasRange ? {\n                start: currentRanges.start(i),\n                end: currentRanges.end(i)\n            } : null;\n            newStart = newRanges.start(i);\n            newEnd = newRanges.end(i);\n\n            // if there is no range with the same index it means that a new range has been added. This range is\n            // the difference we are looking for\n            // Example\n            // current ranges\n            // 0|---range1---|4  8|--range2--|12\n            // new ranges\n            // 0|---range1---|4| 8|--range2--|12  16|--range3--|20\n\n            if (!currentRange) {\n                diff = {\n                    start: newStart,\n                    end: newEnd\n                };\n                return diff;\n            }\n\n            equalStart = currentRange.start === newStart;\n            equalEnd = currentRange.end === newEnd;\n\n            // if ranges are equal do nothing here and go the next ranges\n            if (equalStart && equalEnd) continue;\n\n            // start or/and end of the range has been changed\n            if (equalStart) {\n                diff = {\n                    start: currentRange.end,\n                    end: newEnd\n                };\n            } else if (equalEnd) {\n                diff = {\n                    start: newStart,\n                    end: currentRange.start\n                };\n            } else {\n                // new range has been added before the current one\n                diff = {\n                    start: newStart,\n                    end: newEnd\n                };\n                return diff;\n            }\n\n            // if there is next current range but no next new range (it it is not equal the next current range) it means\n            // that the ranges have been merged\n            // Example 1\n            // current ranges\n            // 0|---range1---|4  8|--range2--|12  16|---range3---|\n            // new ranges\n            // 0|-----------range1-----------|12  16|---range3--|\n            nextCurrentRange = currentRanges.length > (i + 1) ? {\n                start: currentRanges.start(i + 1),\n                end: currentRanges.end(i + 1)\n            } : null;\n            nextNewRange = (i + 1) < ln ? {\n                start: newRanges.start(i + 1),\n                end: newRanges.end(i + 1)\n            } : null;\n\n            if (nextCurrentRange && (!nextNewRange || (nextNewRange.start !== nextCurrentRange.start || nextNewRange.end !== nextCurrentRange.end))) {\n                diff.end = nextCurrentRange.start;\n            }\n\n            return diff;\n        }\n\n        return null;\n    }\n\n    function append(buffer, chunk) {\n        if (!buffer || !chunk) {\n            eventBus.trigger(Events.SOURCEBUFFER_APPEND_COMPLETED, {\n                buffer: null,\n                bytes: null,\n                error: new DashJSError(APPEND_ERROR_CODE, APPEND_ERROR_MESSAGE, null)\n            });\n            return;\n        }\n        let bytes = chunk.bytes;\n\n        let appendMethod = ('append' in buffer) ? 'append' : (('appendBuffer' in buffer) ? 'appendBuffer' : null);\n        // our user-defined sourcebuffer-like object has Object as its\n        // prototype whereas built-in SourceBuffers will have something\n        // more sensible. do not pass chunk to built-in append.\n        let acceptsChunk = Object.prototype.toString.call(buffer).slice(8, -1) === 'Object';\n\n        if (!appendMethod) return;\n\n        waitForUpdateEnd(buffer, function () {\n            try {\n                if (acceptsChunk) {\n                    // chunk.start is used in calculations by TextSourceBuffer\n                    buffer[appendMethod](bytes, chunk);\n                } else {\n                    buffer[appendMethod](bytes);\n                }\n                // updating is in progress, we should wait for it to complete before signaling that this operation is done\n                waitForUpdateEnd(buffer, function () {\n                    eventBus.trigger(Events.SOURCEBUFFER_APPEND_COMPLETED, {\n                        buffer: buffer,\n                        bytes: bytes\n                    });\n                });\n            } catch (err) {\n                eventBus.trigger(Events.SOURCEBUFFER_APPEND_COMPLETED, {\n                    buffer: buffer,\n                    bytes: bytes,\n                    error: new DashJSError(err.code, err.message, null)\n                });\n            }\n        });\n    }\n\n    function remove(buffer, start, end, mediaSource) {\n        if (!buffer) {\n            eventBus.trigger(Events.SOURCEBUFFER_REMOVE_COMPLETED, {\n                buffer: buffer,\n                from: start,\n                to: end,\n                error: new DashJSError(REMOVE_ERROR_CODE, REMOVE_ERROR_MESSAGE, null)\n            });\n            return;\n        }\n        // make sure that the given time range is correct. Otherwise we will get InvalidAccessError\n        waitForUpdateEnd(buffer, function () {\n            try {\n                if ((start >= 0) && (end > start) && (mediaSource.readyState !== 'ended')) {\n                    buffer.remove(start, end);\n                }\n                // updating is in progress, we should wait for it to complete before signaling that this operation is done\n                waitForUpdateEnd(buffer, function () {\n                    eventBus.trigger(Events.SOURCEBUFFER_REMOVE_COMPLETED, {\n                        buffer: buffer,\n                        from: start,\n                        to: end\n                    });\n                });\n            } catch (err) {\n                eventBus.trigger(Events.SOURCEBUFFER_REMOVE_COMPLETED, {\n                    buffer: buffer,\n                    from: start,\n                    to: end,\n                    error: new DashJSError(err.code, err.message, null)\n                });\n            }\n        });\n    }\n\n    function abort(mediaSource, buffer) {\n        try {\n            if (mediaSource.readyState === 'open') {\n                buffer.abort();\n            } else if (buffer.resetEmbedded && mediaSource.readyState === 'ended') {\n                buffer.abort(); //The cues need to be removed from the TextSourceBuffer via a call to abort()\n            }\n        } catch (ex) {}\n    }\n\n    function waitForUpdateEnd(buffer, callback) {\n        let intervalId;\n        const CHECK_INTERVAL = 50;\n\n        const checkIsUpdateEnded = function () {\n            // if updating is still in progress do nothing and wait for the next check again.\n            if (buffer.updating) return;\n            // updating is completed, now we can stop checking and resolve the promise\n            clearInterval(intervalId);\n            callback();\n        };\n\n        const updateEndHandler = function () {\n            if (buffer.updating) return;\n\n            buffer.removeEventListener('updateend', updateEndHandler, false);\n            callback();\n        };\n\n        if (!buffer.updating) {\n            callback();\n            return;\n        }\n\n        // use updateend event if possible\n        if (typeof buffer.addEventListener === 'function') {\n            try {\n                buffer.addEventListener('updateend', updateEndHandler, false);\n            } catch (err) {\n                // use setInterval to periodically check if updating has been completed\n                intervalId = setInterval(checkIsUpdateEnded, CHECK_INTERVAL);\n            }\n        } else {\n            // use setInterval to periodically check if updating has been completed\n            intervalId = setInterval(checkIsUpdateEnded, CHECK_INTERVAL);\n        }\n    }\n\n    instance = {\n        append: append,\n        remove: remove,\n        abort: abort,\n        createSourceBuffer: createSourceBuffer,\n        removeSourceBuffer: removeSourceBuffer,\n        getBufferRange: getBufferRange,\n        getAllRanges: getAllRanges,\n        getTotalBufferedTime: getTotalBufferedTime,\n        getBufferLength: getBufferLength,\n        getRangeDifference: getRangeDifference\n    };\n\n    return instance;\n}\n\nSourceBufferController.__dashjs_factory_name = 'SourceBufferController';\nlet factory = FactoryMaker.getSingletonFactory(SourceBufferController);\nfactory.QUOTA_EXCEEDED_ERROR_CODE = QUOTA_EXCEEDED_ERROR_CODE;\nFactoryMaker.updateSingletonFactory(SourceBufferController.__dashjs_factory_name, factory);\nexport default factory;\n"]}