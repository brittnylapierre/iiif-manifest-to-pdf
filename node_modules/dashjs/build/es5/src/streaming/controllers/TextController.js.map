{"version":3,"sources":["../../../../../src/streaming/controllers/TextController.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;4BA8BqB,qBAAqB;;;;gCACvB,0BAA0B;;;;gCACpB,yBAAyB;;;;AAElD,SAAS,cAAc,CAAC,MAAM,EAAE;;AAE5B,QAAI,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC;AAC3B,QAAI,QAAQ,GAAG,+BAAS,OAAO,CAAC,CAAC,WAAW,EAAE,CAAC;;AAE/C,QAAI,sBAAsB,GAAG,MAAM,CAAC,sBAAsB,CAAC;AAC3D,QAAI,UAAU,GAAG,MAAM,CAAC,UAAU,CAAC;;AAEnC,QAAI,QAAQ,YAAA;QACR,oBAAoB,YAAA;QACpB,WAAW,YAAA;QACX,WAAW,YAAA;QACX,MAAM,YAAA;QACN,IAAI,YAAA;QACJ,eAAe,YAAA;QACf,wBAAwB,YAAA,CAAC;;AAE7B,aAAS,KAAK,GAAG;;AAEb,mBAAW,GAAG,KAAK,CAAC;AACpB,mBAAW,GAAG,IAAI,CAAC;AACnB,cAAM,GAAG,IAAI,CAAC;AACd,YAAI,GAAG,IAAI,CAAC;AACZ,uBAAe,GAAG,IAAI,CAAC;AACvB,gCAAwB,GAAG,IAAI,CAAC;AAChC,4BAAoB,GAAG,KAAK,CAAC;;AAE7B,gBAAQ,CAAC,EAAE,CAAC,8BAAO,qBAAqB,EAAE,qBAAqB,EAAE,IAAI,CAAC,CAAC;AACvE,gBAAQ,CAAC,EAAE,CAAC,8BAAO,oBAAoB,EAAE,oBAAoB,EAAE,IAAI,CAAC,CAAC;KACxE;;AAED,aAAS,UAAU,CAAC,IAAI,EAAE,MAAM,EAAE,eAAe,EAAE;AAC/C,YAAI,GAAG,IAAI,CAAC;AACZ,sBAAc,CAAC,MAAM,CAAC,CAAC;AACvB,uBAAe,GAAG,eAAe,CAAC;AAClC,gCAAwB,GAAG,eAAe,CAAC,2BAA2B,EAAE,CAAC;KAC5E;;;;;;;AAOD,aAAS,YAAY,CAAC,SAAS,EAAE;AAC7B,YAAI;AACA,kBAAM,GAAG,sBAAsB,CAAC,kBAAkB,CAAC,WAAW,EAAE,SAAS,CAAC,CAAC;;AAE3E,gBAAI,CAAC,WAAW,EAAE;AACd,oBAAI,MAAM,CAAC,cAAc,CAAC,YAAY,CAAC,EAAE;AACrC,0BAAM,CAAC,UAAU,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;iBACjC;AACD,2BAAW,GAAG,IAAI,CAAC;aACtB;SACJ,CAAC,OAAO,CAAC,EAAE;AACR,sBAAU,CAAC,gBAAgB,CAAC,iBAAiB,GAAG,IAAI,GAAG,iBAAiB,CAAC,CAAC;SAC7E;;AAED,eAAO,MAAM,CAAC;KACjB;;AAED,aAAS,SAAS,GAAG;AACjB,eAAO,MAAM,CAAC;KACjB;;AAED,aAAS,SAAS,CAAC,KAAK,EAAE;AACtB,cAAM,GAAG,KAAK,CAAC;KAClB;;AAED,aAAS,cAAc,CAAC,KAAK,EAAE;AAC3B,mBAAW,GAAG,KAAK,CAAC;KACvB;;AAED,aAAS,kBAAkB,GAAG;AAC1B,eAAO,eAAe,CAAC;KAC1B;;AAED,aAAS,KAAK,CAAC,OAAO,EAAE;;AAEpB,gBAAQ,CAAC,GAAG,CAAC,8BAAO,qBAAqB,EAAE,qBAAqB,EAAE,IAAI,CAAC,CAAC;AACxE,gBAAQ,CAAC,GAAG,CAAC,8BAAO,oBAAoB,EAAE,oBAAoB,EAAE,IAAI,CAAC,CAAC;;AAEtE,YAAI,CAAC,OAAO,EAAE;AACV,kCAAsB,CAAC,KAAK,CAAC,WAAW,EAAE,MAAM,CAAC,CAAC;AAClD,kCAAsB,CAAC,kBAAkB,CAAC,WAAW,EAAE,MAAM,CAAC,CAAC;SAClE;KACJ;;AAED,aAAS,qBAAqB,CAAC,CAAC,EAAE;AAC9B,YAAI,CAAC,CAAC,MAAM,CAAC,kBAAkB,EAAE,KAAK,eAAe,EAAE,OAAO;AAC9D,gBAAQ,CAAC,OAAO,CAAC,8BAAO,oBAAoB,EAAE,EAAE,KAAK,EAAE,CAAC,EAAE,MAAM,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC,CAAC;KACjF;;AAED,aAAS,oBAAoB,CAAC,CAAC,EAAE;AAC7B,YAAI,CAAC,CAAC,aAAa,KAAK,eAAe,CAAC,gBAAgB,EAAE,IAAK,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,AAAC,EAAE,OAAO;AACvF,8BAAsB,CAAC,MAAM,CAAC,MAAM,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC;KAClD;;AAED,aAAS,uBAAuB,GAAG;AAC/B,eAAO,oBAAoB,CAAC;KAC/B;;AAED,YAAQ,GAAG;AACP,kBAAU,EAAE,UAAU;AACtB,oBAAY,EAAE,YAAY;AAC1B,iBAAS,EAAE,SAAS;AACpB,iBAAS,EAAE,SAAS;AACpB,0BAAkB,EAAE,kBAAkB;AACtC,+BAAuB,EAAE,uBAAuB;AAChD,sBAAc,EAAE,cAAc;AAC9B,aAAK,EAAE,KAAK;KACf,CAAC;;AAEF,SAAK,EAAE,CAAC;;AAER,WAAO,QAAQ,CAAC;CACnB;;AAED,cAAc,CAAC,qBAAqB,GAAG,gBAAgB,CAAC;qBACzC,8BAAa,eAAe,CAAC,cAAc,CAAC","file":"TextController.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport EventBus from '../../core/EventBus';\nimport Events from '../../core/events/Events';\nimport FactoryMaker from '../../core/FactoryMaker';\n\nfunction TextController(config) {\n\n    let context = this.context;\n    let eventBus = EventBus(context).getInstance();\n\n    let sourceBufferController = config.sourceBufferController;\n    let errHandler = config.errHandler;\n\n    let instance,\n        isBufferingCompleted,\n        initialized,\n        mediaSource,\n        buffer,\n        type,\n        streamProcessor,\n        representationController;\n\n    function setup() {\n\n        initialized = false;\n        mediaSource = null;\n        buffer = null;\n        type = null;\n        streamProcessor = null;\n        representationController = null;\n        isBufferingCompleted = false;\n\n        eventBus.on(Events.DATA_UPDATE_COMPLETED, onDataUpdateCompleted, this);\n        eventBus.on(Events.INIT_FRAGMENT_LOADED, onInitFragmentLoaded, this);\n    }\n\n    function initialize(Type, source, StreamProcessor) {\n        type = Type;\n        setMediaSource(source);\n        streamProcessor = StreamProcessor;\n        representationController = streamProcessor.getRepresentationController();\n    }\n\n    /**\n     * @param {MediaInfo }mediaInfo\n     * @returns {Object} SourceBuffer object\n     * @memberof BufferController#\n     */\n    function createBuffer(mediaInfo) {\n        try {\n            buffer = sourceBufferController.createSourceBuffer(mediaSource, mediaInfo);\n\n            if (!initialized) {\n                if (buffer.hasOwnProperty('initialize')) {\n                    buffer.initialize(type, this);\n                }\n                initialized = true;\n            }\n        } catch (e) {\n            errHandler.mediaSourceError('Error creating ' + type + ' source buffer.');\n        }\n\n        return buffer;\n    }\n\n    function getBuffer() {\n        return buffer;\n    }\n\n    function setBuffer(value) {\n        buffer = value;\n    }\n\n    function setMediaSource(value) {\n        mediaSource = value;\n    }\n\n    function getStreamProcessor() {\n        return streamProcessor;\n    }\n\n    function reset(errored) {\n\n        eventBus.off(Events.DATA_UPDATE_COMPLETED, onDataUpdateCompleted, this);\n        eventBus.off(Events.INIT_FRAGMENT_LOADED, onInitFragmentLoaded, this);\n\n        if (!errored) {\n            sourceBufferController.abort(mediaSource, buffer);\n            sourceBufferController.removeSourceBuffer(mediaSource, buffer);\n        }\n    }\n\n    function onDataUpdateCompleted(e) {\n        if (e.sender.getStreamProcessor() !== streamProcessor) return;\n        eventBus.trigger(Events.TIMED_TEXT_REQUESTED, { index: 0, sender: e.sender }); //TODO make index dynamic if referring to MP?\n    }\n\n    function onInitFragmentLoaded(e) {\n        if (e.fragmentModel !== streamProcessor.getFragmentModel() || (!e.chunk.bytes)) return;\n        sourceBufferController.append(buffer, e.chunk);\n    }\n\n    function getIsBufferingCompleted() {\n        return isBufferingCompleted;\n    }\n\n    instance = {\n        initialize: initialize,\n        createBuffer: createBuffer,\n        getBuffer: getBuffer,\n        setBuffer: setBuffer,\n        getStreamProcessor: getStreamProcessor,\n        getIsBufferingCompleted: getIsBufferingCompleted,\n        setMediaSource: setMediaSource,\n        reset: reset\n    };\n\n    setup();\n\n    return instance;\n}\n\nTextController.__dashjs_factory_name = 'TextController';\nexport default FactoryMaker.getClassFactory(TextController);\n"]}