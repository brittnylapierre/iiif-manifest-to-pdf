{"version":3,"sources":["../../../../../src/streaming/rules/RulesController.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;4BA8ByB,gBAAgB;;;;6BACf,iBAAiB;;;;qCACZ,0BAA0B;;;;gCAChC,yBAAyB;;;;AAElD,IAAM,QAAQ,GAAG,CAAC,CAAC;;AAEnB,SAAS,eAAe,GAAG;;AAEvB,QAAI,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC;;AAE3B,QAAI,QAAQ,YAAA;QACR,KAAK,YAAA,CAAC;;AAEV,aAAS,UAAU,GAAG;AAClB,aAAK,GAAG,EAAE,CAAC;KACd;;AAED,aAAS,SAAS,CAAC,MAAM,EAAE;AACvB,YAAI,CAAC,MAAM,EAAE,OAAO;;AAEpB,YAAI,MAAM,CAAC,kBAAkB,EAAE;AAC3B,iBAAK,CAAC,QAAQ,CAAC,GAAG,MAAM,CAAC,kBAAkB,CAAC;SAC/C;KACJ;;AAED,aAAS,UAAU,CAAC,QAAQ,EAAE,eAAe,EAAE,QAAQ,EAAE,OAAO,EAAE,eAAe,EAAE,YAAY,EAAE;AAC7F,YAAI,MAAM,GAAG,EAAE,CAAC;AAChB,YAAI,OAAO,GAAG,EAAE,CAAC;AACjB,YAAI,IAAI,EACJ,CAAC,CAAC;;AAEN,YAAI,UAAU,GAAG,QAAQ,CAAC,MAAM,CAAC;AACjC,YAAI,EAAE,GAAG,UAAU,CAAC;AACpB,YAAI,YAAY,GAAG,eAAe,CAAC,eAAe,EAAE,OAAO,CAAC,CAAC;;AAE7D,YAAI,YAAY,GAAG,SAAf,YAAY,CAAa,MAAM,EAAE;AACjC,gBAAI,KAAK,EACL,MAAM,EACN,UAAU,CAAC;;AAEf,gBAAI,MAAM,CAAC,KAAK,KAAK,2BAAc,SAAS,EAAE;AAC1C,oBAAI,QAAQ,GAAG,YAAY,CAAC,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,MAAM,CAAC,KAAK,CAAC,CAAC;AACnE,oBAAI,QAAQ,KAAK,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE;;AAEtC,0BAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,QAAQ,CAAC;AACnC,2BAAO,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,MAAM,CAAC,MAAM,CAAC;iBAC5C;aACJ;;AAED,gBAAI,EAAE,UAAU,EAAE,OAAO;;AAEzB,gBAAI,MAAM,CAAC,2BAAc,IAAI,CAAC,KAAK,2BAAc,SAAS,EAAE;AACxD,0BAAU,GAAG,2BAAc,IAAI,CAAC;AAChC,qBAAK,GAAG,MAAM,CAAC,2BAAc,IAAI,CAAC,CAAC;AACnC,sBAAM,GAAG,OAAO,CAAC,2BAAc,IAAI,CAAC,CAAC;aACxC;;AAED,gBAAI,MAAM,CAAC,2BAAc,OAAO,CAAC,KAAK,2BAAc,SAAS,EAAE;AAC3D,0BAAU,GAAG,2BAAc,OAAO,CAAC;AACnC,qBAAK,GAAG,MAAM,CAAC,2BAAc,OAAO,CAAC,CAAC;AACtC,sBAAM,GAAG,OAAO,CAAC,2BAAc,OAAO,CAAC,CAAC;aAC3C;;AAED,gBAAI,MAAM,CAAC,2BAAc,MAAM,CAAC,KAAK,2BAAc,SAAS,EAAE;AAC1D,0BAAU,GAAG,2BAAc,MAAM,CAAC;AAClC,qBAAK,GAAG,MAAM,CAAC,2BAAc,MAAM,CAAC,CAAC;AACrC,sBAAM,GAAG,OAAO,CAAC,2BAAc,MAAM,CAAC,CAAC;aAC1C;;AAED,gBAAI,UAAU,IAAI,2BAAc,MAAM,IAClC,UAAU,IAAI,2BAAc,IAAI,EAAE;AAClC,0BAAU,GAAG,2BAAc,OAAO,CAAC;aACtC;;AAED,gBAAI,KAAK,KAAK,SAAS,EAAE;AACrB,wBAAQ,CAAC,EAAE,KAAK,EAAE,KAAK,EAAE,UAAU,EAAE,UAAU,EAAE,MAAM,EAAE,MAAM,EAAC,CAAC,CAAC;aACrE,MAAM;AACH,wBAAQ,CAAC,EAAE,KAAK,EAAE,OAAO,EAAE,UAAU,EAAE,UAAU,EAAE,MAAM,EAAE,EAAC,IAAI,EAAE,WAAW,EAAC,EAAC,CAAC,CAAC;aACpF;SACJ,CAAC;;AAEF,cAAM,CAAC,2BAAc,MAAM,CAAC,GAAG,2BAAc,SAAS,CAAC;AACvD,cAAM,CAAC,2BAAc,IAAI,CAAC,GAAG,2BAAc,SAAS,CAAC;AACrD,cAAM,CAAC,2BAAc,OAAO,CAAC,GAAG,2BAAc,SAAS,CAAC;;AAExD,aAAK,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,EAAE;AACrB,gBAAI,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAC;AACnB,gBAAI,CAAC,OAAO,CAAC,YAAY,EAAE,YAAY,CAAC,CAAC;SAC5C;KACJ;;AAED,aAAS,KAAK,GAAG;AACb,YAAI,QAAQ,GAAG,KAAK,CAAC,QAAQ,CAAC,CAAC;AAC/B,YAAI,QAAQ,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC,mCAAmB,oBAAoB,CAAC,IAAI,EAAE,CAAA,CAAE,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,mCAAmB,sBAAsB,CAAC,IAAI,EAAE,CAAC,CAAC;AAC7J,YAAI,EAAE,GAAG,QAAQ,CAAC,MAAM,CAAC;;AAEzB,YAAI,IAAI,EACJ,CAAC,CAAC;;AAEN,aAAK,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,EAAE;AACrB,gBAAI,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAC;;AAEnB,gBAAI,OAAQ,IAAI,CAAC,KAAK,AAAC,KAAK,UAAU,EAAE,SAAS;;AAEjD,gBAAI,CAAC,KAAK,EAAE,CAAC;SAChB;;AAED,aAAK,GAAG,EAAE,CAAC;KACd;;AAED,aAAS,eAAe,CAAC,eAAe,EAAE,YAAY,EAAE;AACpD,eAAO,+BAAa,OAAO,CAAC,CAAC,MAAM,CAAC,EAAC,eAAe,EAAE,eAAe,EAAE,YAAY,EAAE,YAAY,EAAC,CAAC,CAAC;KACvG;;AAED,YAAQ,GAAG;AACP,kBAAU,EAAE,UAAU;AACtB,iBAAS,EAAE,SAAS;AACpB,kBAAU,EAAE,UAAU;AACtB,aAAK,EAAE,KAAK;KACf,CAAC;;AAEF,WAAO,QAAQ,CAAC;CACnB;;AAED,eAAe,CAAC,qBAAqB,GAAG,iBAAiB,CAAC;AAC1D,IAAI,OAAO,GAAI,8BAAa,mBAAmB,CAAC,eAAe,CAAC,CAAC;AACjE,OAAO,CAAC,QAAQ,GAAG,QAAQ,CAAC;qBACb,OAAO","file":"RulesController.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport RulesContext from './RulesContext';\nimport SwitchRequest from './SwitchRequest';\nimport ABRRulesCollection from './abr/ABRRulesCollection';\nimport FactoryMaker from '../../core/FactoryMaker';\n\nconst ABR_RULE = 0;\n\nfunction RulesController() {\n\n    let context = this.context;\n\n    let instance,\n        rules;\n\n    function initialize() {\n        rules = {};\n    }\n\n    function setConfig(config) {\n        if (!config) return;\n\n        if (config.abrRulesCollection) {\n            rules[ABR_RULE] = config.abrRulesCollection;\n        }\n    }\n\n    function applyRules(rulesArr, streamProcessor, callback, current, playbackQuality, overrideFunc) {\n        var values = {};\n        var reasons = {};\n        var rule,\n            i;\n\n        var rulesCount = rulesArr.length;\n        var ln = rulesCount;\n        var rulesContext = getRulesContext(streamProcessor, current);\n\n        var callbackFunc = function (result) {\n            var value,\n                reason,\n                confidence;\n\n            if (result.value !== SwitchRequest.NO_CHANGE) {\n                var newValue = overrideFunc(values[result.priority], result.value);\n                if (newValue !== values[result.priority]) {\n                    // change in value\n                    values[result.priority] = newValue; // === result.value\n                    reasons[result.priority] = result.reason;\n                }\n            }\n\n            if (--rulesCount) return;\n\n            if (values[SwitchRequest.WEAK] !== SwitchRequest.NO_CHANGE) {\n                confidence = SwitchRequest.WEAK;\n                value = values[SwitchRequest.WEAK];\n                reason = reasons[SwitchRequest.WEAK];\n            }\n\n            if (values[SwitchRequest.DEFAULT] !== SwitchRequest.NO_CHANGE) {\n                confidence = SwitchRequest.DEFAULT;\n                value = values[SwitchRequest.DEFAULT];\n                reason = reasons[SwitchRequest.DEFAULT];\n            }\n\n            if (values[SwitchRequest.STRONG] !== SwitchRequest.NO_CHANGE) {\n                confidence = SwitchRequest.STRONG;\n                value = values[SwitchRequest.STRONG];\n                reason = reasons[SwitchRequest.STRONG];\n            }\n\n            if (confidence != SwitchRequest.STRONG &&\n                confidence != SwitchRequest.WEAK) {\n                confidence = SwitchRequest.DEFAULT;\n            }\n\n            if (value !== undefined) {\n                callback({ value: value, confidence: confidence, reason: reason});\n            } else {\n                callback({ value: current, confidence: confidence, reason: {name: 'NO_CHANGE'}});\n            }\n        };\n\n        values[SwitchRequest.STRONG] = SwitchRequest.NO_CHANGE;\n        values[SwitchRequest.WEAK] = SwitchRequest.NO_CHANGE;\n        values[SwitchRequest.DEFAULT] = SwitchRequest.NO_CHANGE;\n\n        for (i = 0; i < ln; i++) {\n            rule = rulesArr[i];\n            rule.execute(rulesContext, callbackFunc);\n        }\n    }\n\n    function reset() {\n        var abrRules = rules[ABR_RULE];\n        var allRules = (abrRules.getRules(ABRRulesCollection.QUALITY_SWITCH_RULES) || []).concat(abrRules.getRules(ABRRulesCollection.ABANDON_FRAGMENT_RULES) || []);\n        var ln = allRules.length;\n\n        var rule,\n            i;\n\n        for (i = 0; i < ln; i++) {\n            rule = allRules[i];\n\n            if (typeof (rule.reset) !== 'function') continue;\n\n            rule.reset();\n        }\n\n        rules = {};\n    }\n\n    function getRulesContext(streamProcessor, currentValue) {\n        return RulesContext(context).create({streamProcessor: streamProcessor, currentValue: currentValue});\n    }\n\n    instance = {\n        initialize: initialize,\n        setConfig: setConfig,\n        applyRules: applyRules,\n        reset: reset\n    };\n\n    return instance;\n}\n\nRulesController.__dashjs_factory_name = 'RulesController';\nlet factory =  FactoryMaker.getSingletonFactory(RulesController);\nfactory.ABR_RULE = ABR_RULE;\nexport default factory;\n"]}