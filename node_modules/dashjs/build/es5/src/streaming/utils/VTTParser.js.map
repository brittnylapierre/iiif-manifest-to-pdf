{"version":3,"sources":["../../../../../src/streaming/utils/VTTParser.js"],"names":[],"mappings":"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","file":"VTTParser.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport FactoryMaker from '../../core/FactoryMaker';\nimport Debug from '../../core/Debug';\n\nconst WEBVTT = 'WEBVTT';\n\nfunction VTTParser() {\n    let context = this.context;\n    let log = Debug(context).getInstance().log;\n\n    let instance,\n        regExNewLine,\n        regExToken,\n        regExWhiteSpace,\n        regExWhiteSpaceWordBoundary;\n\n    function setup() {\n        regExNewLine = /(?:\\r\\n|\\r|\\n)/gm;\n        regExToken = /-->/;\n        regExWhiteSpace = /(^[\\s]+|[\\s]+$)/g;\n        regExWhiteSpaceWordBoundary = /\\s\\b/g;\n    }\n\n    function parse(data) {\n        let captionArray = [];\n        let len,\n            lastStartTime;\n\n        if (!data) {\n            return captionArray;\n        }\n\n        data = data.split( regExNewLine );\n        len = data.length;\n        lastStartTime = -1;\n\n        for (let i = 0 ; i < len; i++)\n        {\n            let item = data[i];\n\n            if (item.length > 0 && item !== WEBVTT)\n            {\n                if (item.match(regExToken))\n                {\n                    let attributes = parseItemAttributes(item);\n                    let cuePoints = attributes.cuePoints;\n                    let styles = attributes.styles;\n                    let text = getSublines(data, i + 1);\n                    let startTime = convertCuePointTimes(cuePoints[0].replace(regExWhiteSpace, ''));\n                    let endTime = convertCuePointTimes(cuePoints[1].replace(regExWhiteSpace, ''));\n\n                    if ((!isNaN(startTime) && !isNaN(endTime)) && startTime >= lastStartTime && endTime > startTime) {\n                        if (text !== '') {\n                            lastStartTime = startTime;\n                            //TODO Make VO external so other parsers can use.\n                            captionArray.push({\n                                start: startTime,\n                                end: endTime,\n                                data: text,\n                                styles: styles\n                            });\n                        }\n                        else {\n                            log('Skipping cue due to empty/malformed cue text');\n                        }\n                    }\n                    else {\n                        log('Skipping cue due to incorrect cue timing');\n                    }\n                }\n            }\n        }\n\n        return captionArray;\n    }\n\n    function convertCuePointTimes(time) {\n        let timeArray = time.split(':');\n        const len = timeArray.length - 1;\n\n        time = parseInt( timeArray[len - 1], 10 ) * 60 + parseFloat( timeArray[len]);\n\n        if ( len === 2 ) {\n            time += parseInt( timeArray[0], 10 ) * 3600;\n        }\n\n        return time;\n    }\n\n    function parseItemAttributes(data) {\n        let vttCuePoints = data.split(regExToken);\n        let arr = vttCuePoints[1].split(regExWhiteSpaceWordBoundary);\n        arr.shift(); //remove first array index it is empty...\n        vttCuePoints[1] = arr[0];\n        arr.shift();\n        return {cuePoints: vttCuePoints, styles: getCaptionStyles(arr)};\n    }\n\n    function getCaptionStyles(arr) {\n        let styleObject = {};\n        arr.forEach(function (element) {\n            if (element.split(/:/).length > 1) {\n                let val = element.split(/:/)[1];\n                if (val && val.search(/%/) != -1) {\n                    val = parseInt(val.replace(/%/, ''), 10);\n                }\n                if (element.match(/align/) || element.match(/A/)) {\n                    styleObject.align = val;\n                }\n                if (element.match(/line/) || element.match(/L/) ) {\n                    styleObject.line = val;\n                }\n                if (element.match(/position/) || element.match(/P/) ) {\n                    styleObject.position = val;\n                }\n                if (element.match(/size/) || element.match(/S/)) {\n                    styleObject.size = val;\n                }\n            }\n        });\n\n        return styleObject;\n    }\n\n    /*\n    * VTT can have multiple lines to display per cuepoint.\n    */\n    function getSublines(data, idx) {\n        let i = idx;\n\n        let subline = '';\n        let lineData = '';\n        let lineCount;\n\n        while (data[i] !== '' && i < data.length) {\n            i++;\n        }\n\n        lineCount = i - idx;\n        if (lineCount > 1) {\n            for (let j = 0; j < lineCount; j++) {\n                lineData = data[(idx + j)];\n                if (!lineData.match(regExToken)) {\n                    subline += lineData;\n                    if (j !== lineCount - 1) {\n                        subline += '\\n';\n                    }\n                }\n                else {\n                    // caption text should not have '-->' in it\n                    subline = '';\n                    break;\n                }\n            }\n        } else {\n            lineData = data[idx];\n            if (!lineData.match(regExToken))\n                subline = lineData;\n        }\n        return subline;\n    }\n\n    instance = {\n        parse: parse\n    };\n\n    setup();\n    return instance;\n}\nVTTParser.__dashjs_factory_name = 'VTTParser';\nexport default FactoryMaker.getSingletonFactory(VTTParser);\n"]}