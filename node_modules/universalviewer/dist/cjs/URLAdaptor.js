"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.URLAdaptor = void 0;
var UVAdaptor_1 = require("./UVAdaptor");
var utils_1 = require("@edsilv/utils");
var BaseEvents_1 = require("./modules/uv-shared-module/BaseEvents");
var URLAdaptor = /** @class */ (function (_super) {
    __extends(URLAdaptor, _super);
    function URLAdaptor(readonly) {
        if (readonly === void 0) { readonly = false; }
        return _super.call(this, readonly) || this;
    }
    URLAdaptor.prototype.get = function (key, defaultValue) {
        return (utils_1.Urls.getHashParameter(key, document) ||
            (defaultValue || "").toString() ||
            null);
    };
    URLAdaptor.prototype.getFragment = function (key, url) {
        var regex = new RegExp("#.*" + key + "=([^&]+)(&|$)");
        var match = regex.exec(url);
        return match ? decodeURIComponent(match[1].replace(/\+/g, " ")) : null;
    };
    URLAdaptor.prototype.set = function (key, value) {
        if (!this.readonly) {
            if (value) {
                utils_1.Urls.setHashParameter(key, value.toString(), document);
            }
            else {
                utils_1.Urls.setHashParameter(key, "", document);
            }
        }
    };
    URLAdaptor.prototype.getInitialData = function (overrides) {
        var formattedLocales = [];
        var locales = this.get("locales", "");
        if (locales) {
            var names = locales.split(",");
            for (var i in names) {
                var parts = String(names[i]).split(":");
                formattedLocales[i] = { name: parts[0], label: parts[1] };
            }
        }
        else {
            formattedLocales.push({
                name: "en-GB",
            });
        }
        return __assign({ manifest: this.get("manifest"), collectionIndex: this.get("c") !== undefined
                ? Number(this.get("c"))
                : undefined, manifestIndex: Number(this.get("m", 0)), canvasIndex: Number(this.get("cv", 0)), rotation: Number(this.get("r", 0)), rangeId: this.get("rid", ""), xywh: this.get("xywh", ""), target: this.get("target", ""), cfi: this.get("cfi", ""), locales: formattedLocales.length ? formattedLocales : undefined }, overrides);
    };
    URLAdaptor.prototype.bindTo = function (uv) {
        var _this = this;
        uv.on("pause", function (currentTime) {
            if (currentTime > 0) {
                _this.set("t", currentTime);
            }
        }, false);
        uv.on(BaseEvents_1.BaseEvents.COLLECTION_INDEX_CHANGE, function (collectionIndex) {
            _this.set("c", collectionIndex);
        }, false);
        uv.on(BaseEvents_1.BaseEvents.MANIFEST_INDEX_CHANGE, function (manifestIndex) {
            _this.set("m", manifestIndex);
        }, false);
        uv.on(BaseEvents_1.BaseEvents.CANVAS_INDEX_CHANGE, function (canvasIndex) {
            _this.set("cv", canvasIndex);
        }, false);
        uv.on(BaseEvents_1.BaseEvents.RANGE_CHANGE, function (rangeId) {
            _this.set("rid", rangeId);
        }, false);
        uv.on(BaseEvents_1.BaseEvents.TARGET_CHANGE, function (target) {
            _this.set("xywh", _this.getFragment("xywh", target));
        }, false);
    };
    return URLAdaptor;
}(UVAdaptor_1.UVAdaptor));
exports.URLAdaptor = URLAdaptor;
//# sourceMappingURL=URLAdaptor.js.map